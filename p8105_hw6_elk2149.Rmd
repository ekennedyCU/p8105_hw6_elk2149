---
title: "p8105_hw6_elk2149"
author: "Evan Kennedy"
date: "2025-11-26"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(broom)
library(purrr)
library(p8105.datasets)
library(modelr)

data("weather_df")
set.seed(1)
```

***Problem 1***
```{r}
url = "https://raw.githubusercontent.com/washingtonpost/data-homicides/refs/heads/master/homicide-data.csv"
df_homicide = readr::read_csv(url) |> 
  clean_names() |>
  mutate(
    # Make city_state variable
    city_state = str_c(city, state, sep = ", "),
    
    # Binary solved variable
    solved = disposition == "Closed by arrest",
    
    # Make sure age is numeric
    victim_age = as.numeric(victim_age)
  ) |>
  # Drop specific cities
  filter(
    !city_state %in% c(
      "Dallas, TX",
      "Phoenix, AZ",
      "Kansas City, MO",
      "Tulsa, AL"
    ),
    # Keep only White / Black victims
    victim_race %in% c("White", "Black")
  )

#Log Regression for Baltimore

baltimore_df = df_homicide |>
  filter(city_state == "Baltimore, MD") |>
  mutate(
    # sex and race factors, Female as reference
    victim_sex  = relevel(factor(victim_sex), ref = "Female"),
    victim_race = factor(victim_race)
  )

#log regression
baltimore_logreg = glm(
  solved ~ victim_age + victim_sex + victim_race,
  data   = baltimore_df,
  family = binomial()
)

#get ORs and 95% CI
baltimore_logregtidy = baltimore_logreg |>
  tidy(conf.int = TRUE, conf.level = 0.95, exponentiate = TRUE)

#OR for male vs female
baltimore_male_or = baltimore_logregtidy |>
  filter(term == "victim_sexMale") |>
  select(term, estimate, conf.low, conf.high, p.value)

baltimore_male_or
```

The adjusted odds ratio for a homicide being solved comparing male to female victims, holding age and race constant, was OR = 0.426 (95% CI 0.324, 0.558).

```{r}
# now doing it for all cities

city_or_results =
  df_homicide |>
  # make sure they're factors
  mutate(
    victim_sex  = relevel(factor(victim_sex), ref = "Female"),
    victim_race = factor(victim_race)
  ) |>
 
  # nest by city
  group_by(city_state) |>
  nest() |>
  
  # fit glm for each
  mutate(
    fit = map(
      data,
      ~ glm(
          solved ~ victim_age + victim_sex + victim_race,
          data   = .x,
          family = binomial()
        )
    ),
    # tidy and get ORs and CI
    tidy = map(
      fit,
      ~ tidy(.x, conf.int = TRUE, conf.level = 0.95, exponentiate = TRUE)
    )
  ) |>
  
  select(city_state, tidy) |>
  unnest(tidy) |>
  
  # keep only the male vs female contrast
  filter(term == "victim_sexMale") |>
  arrange(desc(estimate))

city_or_results

#plotting these findings
city_or_results |>
  # ordering cities
  mutate(city_state = fct_reorder(city_state, estimate)) |>
  ggplot(aes(x = estimate, y = city_state)) +
  geom_vline(xintercept = 1) +
  geom_point() +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +
  scale_x_log10() +
  labs(
    x = "Adjusted odds ratio",
    y = "City",
    title = "Adjusted odds ratios for homicide being solved. Male vs female victims, by city."
  )
```

The majority of cities have adjusted odds ratios slightly below 1, suggesting homicides involving male victims may be slightly less likely to be solved than those involving female victims. Given that a large proportion of these CIs do not cross 1.0, this odds is likely statistically significant.

***Problem 2***
```{r}

boot_results =
  tibble(strap = 1:5000) |>
  mutate(
    # bootstrap
    strap_sample = map(strap, ~ sample_frac(weather_df, replace = TRUE)),
    # model
    models = map(strap_sample, ~ lm(tmax ~ tmin + prcp, data = .x)),
    # r-squared
    r2 = map_dbl(models, ~ glance(.x)$r.squared),
    # b1 * b2
    beta_product = map_dbl(
      models,
      ~ {
        coefs = tidy(.x)$estimate
        coefs[2] * coefs[3]
      }
    )
  ) |>
  select(r2, beta_product)

# r dist
ggplot(boot_results, aes(x = r2)) +
  geom_histogram(bins = 40, color = "white") +
  labs(title = "Bootstrap Distribution of R-squared",
       x = "R-squared", y = "Count")

# b1 * b2 dist
ggplot(boot_results, aes(x = beta_product)) +
  geom_histogram(bins = 40, color = "white") +
  labs(title = "Bootstrap Distribution of β1 × β2",
       x = "β1 × β2", y = "Count")

r2_ci =
  boot_results$r2 |>
  quantile(c(0.025, 0.975))

beta_ci =
  boot_results$beta_product |>
  quantile(c(0.025, 0.975))

r2_ci
beta_ci
```

***Problem 3***
```{r}
#pull dataset

birth_df = 
  read_csv("data/birthweight.csv") |>
  clean_names() |>
  mutate(
    babysex = factor(babysex),
    frace   = factor(frace),
    mrace   = factor(mrace),
    malform = factor(malform)
  )
```

model based on citation of previous findings: 

Pre-Pregnancy Body Mass Index, Gestational Weight Gain, and Other Maternal Characteristics in Relation to Infant Birth Weight.
Frederick IO, Williams MA, Sales AE, Martin DP, Killien M.
Maternal and Child Health Journal. 2008;12(5):557-67. doi:10.1007/s10995-007-0276-2.

maternal pre-pregnancy weight (ppwt)
maternal BMI (ppbmi)
gestational weight gain (wtgain)
gestational age (gaweeks)
maternal height (mheight)

```{r}

#bwt ~ ppwt + ppbmi + wtgain + gaweeks + mheight

model_maternal = 
  lm(bwt ~ ppwt + ppbmi + wtgain + gaweeks + mheight, data = birth_df)

#add predictions and residuals

birth_df_aug = 
  birth_df |>
  add_predictions(model_maternal) |>
  add_residuals(model_maternal)


# plot resituals and compare to fitted values
birth_df_aug |>
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.3) +
  geom_smooth(se = FALSE) +
  labs(
    title = "Residuals vs Fitted Values",
    x = "Fitted birthweight",
    y = "Residuals"
  )

#fit comparison models

mod_len_ga = lm(bwt ~ blength + gaweeks, data = birth_df)

mod_interact = lm(bwt ~ bhead * blength * babysex, data = birth_df)

#create splits

cv_df = 
  crossv_mc(birth_df, 100)

#fit models on training dataset

cv_results = cv_df |>
  mutate(
    simple_mod = map(train, ~ lm(bwt ~ gaweeks + blength + bhead + smoken + ppbmi, data = .x)),
    len_ga_mod = map(train, ~ lm(bwt ~ blength + gaweeks, data = .x)),
    interact_mod = map(train, ~ lm(bwt ~ bhead * blength * babysex, data = .x))
  )

#compute RMSE

cv_results = cv_results |>
  mutate(
    rmse_simple   = map2_dbl(simple_mod, test, ~ rmse(model = .x, data = .y)),
    rmse_len_ga   = map2_dbl(len_ga_mod, test, ~ rmse(model = .x, data = .y)),
    rmse_interact = map2_dbl(interact_mod, test, ~ rmse(model = .x, data = .y))
  )


#summarize
cv_results |>
  summarise(
    simple   = mean(rmse_simple),
    len_ga   = mean(rmse_len_ga),
    interact = mean(rmse_interact)
  )


```

